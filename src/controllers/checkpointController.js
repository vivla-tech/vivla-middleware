// Datos estáticos de checkPoints de las casas
const CHECKPOINTS_DATA = [
  {
    "HomeName": "Fir",
    "OwnersCheckPointCount": 2,
    "OwnersCheckPointDates": [
      "2025-02-10",
      "2025-01-21"
    ],
    "HXCheckPointCount": 2,
    "HXCheckPointDates": [
      "2025-08-21",
      "2025-09-08"
    ]
  },
  {
    "HomeName": "Nheu",
    "OwnersCheckPointCount": 3,
    "OwnersCheckPointDates": [
      "2025-01-29",
      "2025-02-10",
      "2025-01-21"
    ],
    "HXCheckPointCount": 3,
    "HXCheckPointDates": [
      "2025-02-17",
      "2025-08-21",
      "2025-09-08"
    ]
  },
  {
    "HomeName": "Naut",
    "OwnersCheckPointCount": 3,
    "OwnersCheckPointDates": [
      "2025-01-29",
      "2025-02-10",
      "2025-01-21"
    ],
    "HXCheckPointCount": 4,
    "HXCheckPointDates": [
      "2025-02-18",
      "2025-08-11",
      "2025-08-26",
      "2025-09-09"
    ]
  },
  {
    "HomeName": "Pinere",
    "OwnersCheckPointCount": 2,
    "OwnersCheckPointDates": [
      "2025-06-25",
      "2025-08-12"
    ],
    "HXCheckPointCount": 3,
    "HXCheckPointDates": [
      "2025-06-26",
      "2025-08-25",
      "2025-09-08"
    ]
  },
  {
    "HomeName": "1500",
    "OwnersCheckPointCount": 4,
    "OwnersCheckPointDates": [
      "2025-01-29",
      "2025-02-10",
      "2025-01-21",
      "2025-06-25"
    ],
    "HXCheckPointCount": 3,
    "HXCheckPointDates": [
      "2025-06-26",
      "2025-08-26",
      "2025-09-08"
    ]
  },
  {
    "HomeName": "Ruda",
    "OwnersCheckPointCount": 3,
    "OwnersCheckPointDates": [
      "2025-01-29",
      "2025-02-10",
      "2025-01-21"
    ],
    "HXCheckPointCount": 3,
    "HXCheckPointDates": [
      "2025-02-18",
      "2025-08-26",
      "2025-09-08"
    ]
  },
  {
    "HomeName": "Nin",
    "OwnersCheckPointCount": 2,
    "OwnersCheckPointDates": [
      "2025-02-10",
      "2025-01-21"
    ],
    "HXCheckPointCount": 2,
    "HXCheckPointDates": [
      "2025-02-17",
      "2025-08-21"
    ]
  },
  {
    "HomeName": "Arties",
    "OwnersCheckPointCount": 2,
    "OwnersCheckPointDates": [
      "2025-02-10",
      "2025-01-21"
    ],
    "HXCheckPointCount": 2,
    "HXCheckPointDates": [
      "2025-02-17",
      "2025-09-09"
    ]
  },
  {
    "HomeName": "Garona",
    "OwnersCheckPointCount": 2,
    "OwnersCheckPointDates": [
      "2025-01-29",
      "2025-01-21"
    ],
    "HXCheckPointCount": 2,
    "HXCheckPointDates": [
      "2025-02-18",
      "2025-08-25"
    ]
  },
  {
    "HomeName": "Tanau",
    "OwnersCheckPointCount": 2,
    "OwnersCheckPointDates": [
      "2025-02-10",
      "2025-08-12"
    ],
    "HXCheckPointCount": 2,
    "HXCheckPointDates": [
      "2025-08-12",
      "2025-08-25"
    ]
  },
  {
    "HomeName": "Oyambre",
    "OwnersCheckPointCount": 1,
    "OwnersCheckPointDates": [
      "2025-05-14"
    ],
    "HXCheckPointCount": 1,
    "HXCheckPointDates": [
      "2025-05-05"
    ]
  },
  {
    "HomeName": "Deveses",
    "OwnersCheckPointCount": 1,
    "OwnersCheckPointDates": [
      "2025-06-23"
    ],
    "HXCheckPointCount": 2,
    "HXCheckPointDates": [
      "2025-02-24",
      "2025-05-14"
    ]
  },
  {
    "HomeName": "Tosalet",
    "OwnersCheckPointCount": 2,
    "OwnersCheckPointDates": [
      "2025-06-23",
      "2025-08-18"
    ],
    "HXCheckPointCount": 2,
    "HXCheckPointDates": [
      "2025-02-24",
      "2025-05-21"
    ]
  },
  {
    "HomeName": "Gades",
    "OwnersCheckPointCount": 1,
    "OwnersCheckPointDates": [
      "2025-09-15"
    ],
    "HXCheckPointCount": 3,
    "HXCheckPointDates": [
      "2025-04-28",
      "2025-07-21",
      "2025-09-22"
    ]
  },
  {
    "HomeName": "Sidonia",
    "OwnersCheckPointCount": 2,
    "OwnersCheckPointDates": [
      "2025-08-11",
      "2025-09-15"
    ],
    "HXCheckPointCount": 3,
    "HXCheckPointDates": [
      "2025-07-24",
      "2025-09-01",
      "2025-09-22"
    ]
  },
  {
    "HomeName": "Nara",
    "OwnersCheckPointCount": 2,
    "OwnersCheckPointDates": [
      "2025-07-21",
      "2025-09-15"
    ],
    "HXCheckPointCount": 2,
    "HXCheckPointDates": [
      "2025-09-01",
      "2025-09-22"
    ]
  },
  {
    "HomeName": "Tuna",
    "OwnersCheckPointCount": 2,
    "OwnersCheckPointDates": [
      "2025-04-07",
      "2025-06-02"
    ],
    "HXCheckPointCount": 2,
    "HXCheckPointDates": [
      "2025-04-28",
      "2025-09-01"
    ]
  },
  {
    "HomeName": "Valderrama",
    "OwnersCheckPointCount": 2,
    "OwnersCheckPointDates": [
      "2025-07-07",
      "2025-09-08"
    ],
    "HXCheckPointCount": 3,
    "HXCheckPointDates": [
      "2025-04-01",
      "2025-07-07",
      "2025-09-08"
    ]
  },
  {
    "HomeName": "Saona",
    "OwnersCheckPointCount": 1,
    "OwnersCheckPointDates": [
      "2025-02-24"
    ],
    "HXCheckPointCount": 3,
    "HXCheckPointDates": [
      "2025-03-03",
      "2025-06-09"
    ]
  },
  {
    "HomeName": "Ribes",
    "OwnersCheckPointCount": 2,
    "OwnersCheckPointDates": [
      "2025-02-24",
      "2025-09-15"
    ],
    "HXCheckPointCount": 3,
    "HXCheckPointDates": [
      "2025-01-23",
      "2025-03-03",
      "2025-06-09"
    ]
  },
  {
    "HomeName": "Coves",
    "OwnersCheckPointCount": 2,
    "OwnersCheckPointDates": [
      "2025-03-25",
      "2025-04-21"
    ],
    "HXCheckPointCount": 2,
    "HXCheckPointDates": [
      "2025-06-02",
      "2025-07-14"
    ]
  },
  {
    "HomeName": "Bini",
    "OwnersCheckPointCount": 3,
    "OwnersCheckPointDates": [
      "2025-03-25",
      "2025-04-21",
      "2025-06-21"
    ],
    "HXCheckPointCount": 2,
    "HXCheckPointDates": [
      "2025-06-04",
      "2025-08-18"
    ]
  },
  {
    "HomeName": "Son_Parc_",
    "OwnersCheckPointCount": 3,
    "OwnersCheckPointDates": [
      "2025-03-25",
      "2025-04-21",
      "2025-04-28"
    ],
    "HXCheckPointCount": 2,
    "HXCheckPointDates": [
      "2025-06-01",
      "2025-07-14"
    ]
  },
  {
    "HomeName": "Son_Parc_II",
    "OwnersCheckPointCount": 4,
    "OwnersCheckPointDates": [
      "2025-03-25",
      "2025-04-21",
      "2025-04-28",
      "2025-07-21"
    ],
    "HXCheckPointCount": 2,
    "HXCheckPointDates": [
      "2025-06-01",
      "2025-07-14"
    ]
  }
];

/**
 * Calcula el estado de los checkPoints basándose en la fecha actual
 * @param {Array} dates - Array de fechas de checkPoints
 * @param {string} currentDate - Fecha actual en formato YYYY-MM-DD
 * @returns {Object} Objeto con conteos de completados, en curso, pendientes y totales
 */
function calculateCheckpointStatus(dates, currentDate) {
    const today = new Date(currentDate);
    const todayStr = currentDate;
    
    let completed = 0;
    let inProgress = 0;
    let pending = 0;
    
    dates.forEach(date => {
        const checkpointDate = new Date(date);
        
        if (checkpointDate < today) {
            completed++;
        } else if (date === todayStr) {
            inProgress++;
        } else {
            pending++;
        }
    });
    
    return {
        completed,
        inProgress,
        pending,
        total: dates.length
    };
}

/**
 * Controlador para obtener los checkPoints de las casas
 * @param {Object} req - Request object
 * @param {Object} res - Response object
 */
export async function getCheckpointsController(req, res) {
    try {
        // Obtener la fecha actual en formato YYYY-MM-DD
        const currentDate = new Date().toISOString().split('T')[0];
        
        // Obtener el parámetro de filtro por nombre de casa
        const { homeName } = req.query;
        
        // Filtrar datos si se proporciona un nombre de casa
        let filteredData = CHECKPOINTS_DATA;
        if (homeName) {
            const searchTerm = homeName.toLowerCase();
            
            // Primero buscar coincidencias exactas (case-insensitive)
            const exactMatches = CHECKPOINTS_DATA.filter(house => 
                house.HomeName.toLowerCase() === searchTerm
            );
            
            if (exactMatches.length > 0) {
                // Si hay coincidencias exactas, usar solo esas
                filteredData = exactMatches;
            } else {
                // Si no hay coincidencias exactas, buscar coincidencias parciales
                filteredData = CHECKPOINTS_DATA.filter(house => 
                    house.HomeName.toLowerCase().includes(searchTerm)
                );
            }
            
            // Si no se encuentra ninguna casa, devolver respuesta vacía
            if (filteredData.length === 0) {
                return res.status(200).json({
                    status: 'success',
                    data: [],
                    count: 0,
                    aggregated: {
                        owners: { completed: 0, inProgress: 0, pending: 0, total: 0 },
                        hx: { completed: 0, inProgress: 0, pending: 0, total: 0 },
                        total: { completed: 0, inProgress: 0, pending: 0, total: 0 }
                    },
                    currentDate: currentDate,
                    message: `No se encontraron casas con el nombre: ${homeName}`,
                    filter: { homeName }
                });
            }
        }
        
        // Calcular datos agregados para Owners CheckPoints (solo de las casas filtradas)
        const allOwnersDates = filteredData.flatMap(house => house.OwnersCheckPointDates);
        const ownersAggregated = calculateCheckpointStatus(allOwnersDates, currentDate);
        
        // Calcular datos agregados para HX CheckPoints (solo de las casas filtradas)
        const allHXDates = filteredData.flatMap(house => house.HXCheckPointDates);
        const hxAggregated = calculateCheckpointStatus(allHXDates, currentDate);
        
        // Calcular datos agregados totales (suma de ambos tipos)
        const allDates = [...allOwnersDates, ...allHXDates];
        const totalAggregated = calculateCheckpointStatus(allDates, currentDate);
        
        // Preparar respuesta
        const response = {
            status: 'success',
            data: filteredData,
            count: filteredData.length,
            aggregated: {
                owners: ownersAggregated,
                hx: hxAggregated,
                total: totalAggregated
            },
            currentDate: currentDate,
            message: homeName 
                ? `CheckPoints de las casas filtradas por nombre "${homeName}" obtenidos exitosamente`
                : 'CheckPoints de las casas obtenidos exitosamente'
        };
        
        // Agregar información del filtro si se aplicó
        if (homeName) {
            response.filter = { homeName };
        }
        
        return res.status(200).json(response);
    } catch (error) {
        console.error('Error en el controlador de checkPoints:', error);
        return res.status(500).json({
            status: 'error',
            message: 'Error interno del servidor',
            error: error.message
        });
    }
}
